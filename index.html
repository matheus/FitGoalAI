<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitGoal AI - Gerador de Treinos</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scan {
            0% {
                top: 0;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .animate-scan {
            animation: scan 2s linear infinite;
        }
    </style>
</head>

<body class="bg-gray-950 text-white min-h-screen flex justify-center">

    <div class="w-full max-w-md bg-gray-900 min-h-screen shadow-2xl relative border-x border-gray-800 flex flex-col">

        <!-- Header -->
        <header
            class="p-6 flex items-center justify-between z-10 bg-gray-900/95 backdrop-blur-sm sticky top-0 border-b border-gray-800">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-1.5 rounded-lg">
                    <i data-lucide="activity" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">FitGoal <span class="text-blue-500">AI</span></h1>
            </div>
            <button id="btn-back" class="hidden text-gray-400 hover:text-white text-sm font-medium">Voltar</button>
            <div id="firebase-status" class="w-2 h-2 rounded-full bg-gray-600" title="Verificando..."></div>
        </header>

        <!-- Main Content -->
        <main id="app-content" class="flex-1 p-6 flex flex-col relative z-10 overflow-y-auto scrollbar-hide"></main>

        <!-- Decor -->
        <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
            <div
                class="absolute top-0 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-blue-600/10 rounded-full blur-[100px]">
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        // Importando Functions para chamar o Backend
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js';

        // --- Configuração ---
        // Quando você fizer o deploy, o Firebase preenche isso automaticamente no hosting
        // Localmente, você precisará colar sua config aqui se não usar o emulador
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app, auth, db, functions;
        let currentUser = null;

        try {
            if (firebaseConfig && firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                functions = getFunctions(app); // Inicializa Functions
                console.log("Firebase conectado.");
            }
        } catch (e) { console.error("Erro init:", e); }

        // --- Estado ---
        const state = {
            step: 1,
            currentPhotoBlob: null, // Armazena o blob para envio
            goalPhotoBlob: null,
            currentPhotoUrl: null, // Para preview
            goalPhotoUrl: null,
            frequency: parseInt(localStorage.getItem('fitgoal_frequency')) || 4,
            duration: parseInt(localStorage.getItem('fitgoal_duration')) || 60,
            isAnalyzing: false,
            generatedPlan: null
        };

        // --- Auth ---
        if (auth) {
            onAuthStateChanged(auth, u => {
                currentUser = u;
                const el = document.getElementById('firebase-status');
                if (el) el.className = u ? "w-2 h-2 rounded-full bg-green-500" : "w-2 h-2 rounded-full bg-red-500";
            });
            signInAnonymously(auth).catch(e => console.error(e));
        }

        // --- Lógica de Renderização (Mantida igual visualmente) ---
        const container = document.getElementById('app-content');
        const btnBack = document.getElementById('btn-back');

        function render() {
            if (state.step > 1 && state.step < 4) {
                btnBack.classList.remove('hidden');
                btnBack.onclick = () => { state.step--; render(); };
            } else { btnBack.classList.add('hidden'); }

            container.innerHTML = '';

            // Steps Dots
            const indicators = document.createElement('div');
            indicators.className = "flex justify-center space-x-2 mb-8";
            [1, 2, 3, 4].forEach(i => {
                const dot = document.createElement('div');
                dot.className = `h-2 w-2 rounded-full transition-all ${state.step === i ? 'w-8 bg-blue-500' : state.step > i ? 'bg-green-500' : 'bg-gray-700'}`;
                indicators.appendChild(dot);
            });
            container.appendChild(indicators);

            if (state.step === 1) renderStep1();
            else if (state.step === 2) renderStep2();
            else if (state.step === 3) renderStep3();
            else if (state.step === 4) renderStep4();
            if (window.lucide) lucide.createIcons();
        }

        // --- Passos ---

        function renderStep1() {
            container.insertAdjacentHTML('beforeend', `
                <div class="flex-1 flex flex-col fade-in">
                    <h2 class="text-2xl font-bold mb-2">Fotos</h2>
                    <p class="text-gray-400 mb-8 text-sm">Selecione fotos claras.</p>
                    <div class="space-y-4 flex-1">
                        <div class="relative bg-gray-800 rounded-2xl p-1 h-40 flex items-center justify-center border border-gray-700 cursor-pointer" onclick="document.getElementById('file-current').click()">
                            <input type="file" id="file-current" class="hidden" accept="image/*">
                            ${state.currentPhotoUrl ? `<img src="${state.currentPhotoUrl}" class="w-full h-full object-cover rounded-xl opacity-80"><div class="absolute top-2 right-2 bg-green-500 p-1 rounded-full"><i data-lucide="check" width="12"></i></div>` : `<div class="text-center text-gray-400"><i data-lucide="camera" class="mx-auto mb-2"></i><span>Atual</span></div>`}
                        </div>
                        <div class="relative bg-gray-800 rounded-2xl p-1 h-40 flex items-center justify-center border border-gray-700 cursor-pointer" onclick="document.getElementById('file-goal').click()">
                            <input type="file" id="file-goal" class="hidden" accept="image/*">
                            ${state.goalPhotoUrl ? `<img src="${state.goalPhotoUrl}" class="w-full h-full object-cover rounded-xl opacity-80"><div class="absolute top-2 right-2 bg-green-500 p-1 rounded-full"><i data-lucide="check" width="12"></i></div>` : `<div class="text-center text-gray-400"><i data-lucide="user" class="mx-auto mb-2"></i><span>Meta</span></div>`}
                        </div>
                    </div>
                    <button id="btn-next-1" class="mt-6 w-full py-4 rounded-xl font-bold bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed" ${!state.currentPhotoUrl || !state.goalPhotoUrl ? 'disabled' : ''}>Próximo</button>
                </div>
            `);

            document.getElementById('file-current').onchange = (e) => handleImage(e, 'current');
            document.getElementById('file-goal').onchange = (e) => handleImage(e, 'goal');
            document.getElementById('btn-next-1').onclick = () => { state.step = 2; render(); };
        }

        function renderStep2() {
            container.insertAdjacentHTML('beforeend', `
                <div class="flex-1 flex flex-col fade-in">
                    <h2 class="text-2xl font-bold mb-2">Configuração</h2>
                    <div class="bg-gray-800/50 p-5 rounded-2xl border border-gray-700/50 mb-4">
                        <div class="flex justify-between mb-2"><span class="font-bold">Frequência</span><span class="text-blue-400">${state.frequency}x</span></div>
                        <input type="range" id="freq-range" min="3" max="6" value="${state.frequency}" class="w-full h-2 bg-gray-700 rounded-lg accent-blue-500">
                    </div>
                    <div class="bg-gray-800/50 p-5 rounded-2xl border border-gray-700/50">
                        <div class="mb-4 font-bold">Duração (min)</div>
                        <div class="grid grid-cols-3 gap-3" id="dur-container"></div>
                    </div>
                    <button id="btn-analyze" class="mt-6 w-full py-4 rounded-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">Gerar Treino com IA</button>
                </div>
            `);

            document.getElementById('freq-range').oninput = (e) => {
                state.frequency = parseInt(e.target.value);
                localStorage.setItem('fitgoal_frequency', state.frequency);
                renderStep2(); // quick rerender for value update
            };

            const durContainer = document.getElementById('dur-container');
            [30, 45, 60, 90].forEach(t => {
                const btn = document.createElement('button');
                btn.className = `py-3 rounded-xl text-sm font-bold border-2 ${state.duration === t ? 'border-purple-500 bg-purple-500/20 text-purple-300' : 'border-transparent bg-gray-800 text-gray-400'}`;
                btn.textContent = t;
                btn.onclick = () => { state.duration = t; localStorage.setItem('fitgoal_duration', t); renderStep2(); };
                durContainer.appendChild(btn);
            });

            document.getElementById('btn-analyze').onclick = () => {
                state.step = 3;
                render();
                callBackendAI(); // CHAMA O BACKEND REAL
            };
        }

        function renderStep3() {
            container.insertAdjacentHTML('beforeend', `
                <div class="flex-1 flex flex-col items-center justify-center text-center fade-in">
                    <div class="relative w-32 h-32 mb-6">
                         <div class="absolute inset-0 border-2 border-blue-500/30 rounded-lg overflow-hidden"><div class="w-full h-1 bg-blue-500 shadow-[0_0_15px_blue] absolute animate-scan"></div></div>
                         <i data-lucide="brain-circuit" class="w-16 h-16 text-gray-600 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                    </div>
                    <h3 class="text-xl font-bold text-blue-400 mb-2">Processando no Servidor Seguro...</h3>
                    <p class="text-sm text-gray-400">Enviando imagens criptografadas para o Gemini Pro.</p>
                </div>
            `);
        }

        function renderStep4() {
            const p = state.generatedPlan;
            let daysHtml = p.schedule.map(day => `
                <div class="bg-gray-800/40 rounded-xl mb-3 border border-gray-700/50">
                    <div class="p-3 border-b border-gray-700/50 flex justify-between"><span class="font-bold">${day.day}</span><span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-1 rounded">${day.focus}</span></div>
                    <div class="p-3 text-sm text-gray-300 space-y-2">
                        ${day.exercises.map(ex => `<div class="flex justify-between"><span>${ex.name}</span><span class="text-gray-500">${ex.sets}</span></div>`).join('')}
                    </div>
                </div>
            `).join('');

            container.insertAdjacentHTML('beforeend', `
                <div class="flex-1 flex flex-col fade-in pb-20">
                    <h2 class="text-2xl font-bold mb-4">${p.title}</h2>
                    <div class="bg-blue-900/20 border border-blue-500/30 p-4 rounded-xl mb-4 text-sm text-blue-200">${p.analysis}</div>
                    <div class="space-y-2">${daysHtml}</div>
                    <button id="btn-reset" class="mt-6 w-full py-4 bg-gray-800 rounded-xl font-bold">Novo Treino</button>
                </div>
            `);
            document.getElementById('btn-reset').onclick = () => { state.step = 1; state.currentPhotoUrl = null; state.goalPhotoUrl = null; render(); };
        }

        // --- LÓGICA DE BACKEND E IMAGEM ---

        // Converte Imagem para Base64 e Redimensiona (para não estourar limite de payload)
        function handleImage(e, type) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Reduz tamanho para envio rápido
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    const base64 = dataUrl.split(',')[1]; // Remove header

                    if (type === 'current') {
                        state.currentPhotoUrl = dataUrl;
                        state.currentPhotoBlob = base64;
                    } else {
                        state.goalPhotoUrl = dataUrl;
                        state.goalPhotoBlob = base64;
                    }
                    render(); // Update UI
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function callBackendAI() {
            if (!functions) {
                alert("Backend não configurado. Verifique o console.");
                state.step = 2; render();
                return;
            }

            try {
                // Chama a Cloud Function 'generateWorkout'
                const generateWorkout = httpsCallable(functions, 'generateWorkout');

                const response = await generateWorkout({
                    currentImage: state.currentPhotoBlob,
                    goalImage: state.goalPhotoBlob,
                    frequency: state.frequency,
                    duration: state.duration
                });

                // Sucesso
                state.generatedPlan = response.data;

                // Salva no Firestore (Opcional - backend pode fazer isso tbm)
                if (currentUser && db) {
                    addDoc(collection(db, 'users', currentUser.uid, 'workouts'), {
                        ...response.data,
                        createdAt: serverTimestamp()
                    });
                }

                state.step = 4;
                render();

            } catch (error) {
                console.error("Erro na IA:", error);
                alert("Erro ao gerar treino: " + error.message);
                state.step = 2; render();
            }
        }

        render();
    </script>
</body>

</html>